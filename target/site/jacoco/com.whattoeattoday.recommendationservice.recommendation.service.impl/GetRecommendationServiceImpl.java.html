<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetRecommendationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RecommendationService</a> &gt; <a href="index.source.html" class="el_package">com.whattoeattoday.recommendationservice.recommendation.service.impl</a> &gt; <span class="el_source">GetRecommendationServiceImpl.java</span></div><h1>GetRecommendationServiceImpl.java</h1><pre class="source lang-java linenums">package com.whattoeattoday.recommendationservice.recommendation.service.impl;

import com.google.api.gax.longrunning.OperationFuture;
import com.google.cloud.dataproc.v1.*;
import com.google.cloud.storage.Blob;
import com.google.cloud.storage.Storage;
import com.google.cloud.storage.StorageOptions;
import com.whattoeattoday.recommendationservice.common.BaseResponse;
import com.whattoeattoday.recommendationservice.common.PageInfo;
import com.whattoeattoday.recommendationservice.common.Status;
import com.whattoeattoday.recommendationservice.recommendation.request.GetRecommendationOnUserRequest;
import com.whattoeattoday.recommendationservice.recommendation.request.GetRecommendationOnItemRequest;
import com.whattoeattoday.recommendationservice.recommendation.service.GetRecommendationService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author Lijie Huang lh3158@columbia.edu
 * @date 10/19/23
 */
<span class="fc" id="L33">@Slf4j</span>
@ConfigurationProperties(prefix = &quot;dataproc&quot;)
@Service
<span class="fc" id="L36">public class GetRecommendationServiceImpl implements GetRecommendationService {</span>

    @Value(&quot;${dataproc.project-id}&quot;)
    private String projectId;

    @Value(&quot;${dataproc.region}&quot;)
    private String region;

    @Value(&quot;${dataproc.cluster-name}&quot;)
    private String clusterName;

    @Resource
    private JdbcTemplate jdbcTemplate;

    @Override
    public BaseResponse&lt;List&lt;String&gt;&gt; getRecommendationOnUser(GetRecommendationOnUserRequest request) {
        // TODO Param Validation
<span class="nc" id="L53">        String mainClass = &quot;com.whattoeattoday.RecommendOnUser&quot;;</span>
<span class="nc" id="L54">        String jarFileUris = &quot;gs://4156-recommend-job/Recommend-1.0-SNAPSHOT.jar&quot;;</span>

<span class="nc" id="L56">        PageInfo pageInfo = PageInfo.builder()</span>
<span class="nc" id="L57">                .pageNo(1)</span>
<span class="nc" id="L58">                .pageSize(100)</span>
<span class="nc" id="L59">                .build();</span>

<span class="nc" id="L61">        StringBuilder querySql = new StringBuilder(String.format(&quot;SELECT item_id FROM collection &quot;));</span>
<span class="nc" id="L62">        querySql.append(String.format(&quot;WHERE user_id = '%s' AND category_name = '%s' &quot;, request.getUserId(), request.getCategoryName()));</span>
<span class="nc" id="L63">        int offset = (pageInfo.getPageNo() - 1) * pageInfo.getPageSize();</span>
<span class="nc" id="L64">        querySql.append(String.format(&quot;LIMIT %s offset %s;&quot;, pageInfo.getPageSize(), offset));</span>
        List&lt;Map&lt;String, Object&gt;&gt; res;
        try {
<span class="nc" id="L67">            res = jdbcTemplate.queryForList(querySql.toString());</span>
<span class="nc" id="L68">        } catch (DataAccessException e) {</span>
<span class="nc" id="L69">            return null;</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">        StringBuilder itemIds = new StringBuilder();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        for (Map&lt;String, Object&gt; map : res) {</span>
<span class="nc" id="L73">            itemIds.append(String.valueOf(map.get(&quot;item_id&quot;)));</span>
<span class="nc" id="L74">            itemIds.append(&quot;,&quot;);</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        itemIds.deleteCharAt(itemIds.length()-1);</span>
<span class="nc" id="L77">        String itemIdsStr = itemIds.toString();</span>

<span class="nc" id="L79">        String tableName = request.getCategoryName();</span>
<span class="nc" id="L80">        List&lt;String&gt; fieldNameArr = request.getFieldNameList();</span>
<span class="nc" id="L81">        StringBuilder fieldNameSb = new StringBuilder();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        for (String fieldName : fieldNameArr) {</span>
<span class="nc" id="L83">            fieldNameSb.append(fieldName);</span>
<span class="nc" id="L84">            fieldNameSb.append(&quot;,&quot;);</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">        fieldNameSb.deleteCharAt(fieldNameSb.length()-1);</span>

<span class="nc" id="L88">        String[] argsArr = new String[]{</span>
            itemIdsStr,
            tableName,
<span class="nc" id="L91">            fieldNameSb.toString(),</span>
<span class="nc" id="L92">            String.valueOf(request.getRankTopSize())};</span>

<span class="nc" id="L94">        List&lt;String&gt; resultList = callDataProc(region, projectId, clusterName, argsArr, mainClass, jarFileUris);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (resultList == null) return BaseResponse.with(Status.FAILURE, &quot;Dataproc Error&quot;);</span>
<span class="nc" id="L96">        return BaseResponse.with(Status.SUCCESS, resultList);</span>
    }

    @Override
    public BaseResponse&lt;List&lt;String&gt;&gt; getRecommendationOnItem(GetRecommendationOnItemRequest request) {
        // TODO Param Check
        // TODO Double Type Unsupported
<span class="fc" id="L103">        String mainClass = &quot;com.whattoeattoday.RecommendOnItem&quot;;</span>
<span class="fc" id="L104">        String jarFileUris = &quot;gs://4156-recommend-job/Recommend-1.0-SNAPSHOT.jar&quot;;</span>

<span class="fc" id="L106">        String tableName = request.getCategoryName();</span>
<span class="fc" id="L107">        List&lt;String&gt; fieldNameArr = request.getFieldNameList();</span>
<span class="fc" id="L108">        StringBuilder fieldNameSb = new StringBuilder();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        for (String fieldName : fieldNameArr) {</span>
<span class="fc" id="L110">            fieldNameSb.append(fieldName);</span>
<span class="fc" id="L111">            fieldNameSb.append(&quot;,&quot;);</span>
<span class="fc" id="L112">        }</span>
<span class="fc" id="L113">        fieldNameSb.deleteCharAt(fieldNameSb.length()-1);</span>

<span class="fc" id="L115">        String[] argsArr = new String[]{</span>
                tableName,
<span class="fc" id="L117">                fieldNameSb.toString(),</span>
<span class="fc" id="L118">                request.getTargetId(),</span>
<span class="fc" id="L119">                String.valueOf(request.getRankTopSize())};</span>

<span class="fc" id="L121">        List&lt;String&gt; resultList = callDataProc(region, projectId, clusterName, argsArr, mainClass, jarFileUris);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (resultList == null) return BaseResponse.with(Status.FAILURE, &quot;Dataproc Error&quot;);</span>
<span class="nc" id="L123">        return BaseResponse.with(Status.SUCCESS, resultList);</span>
    }

    public static List&lt;String&gt; callDataProc(String region, String projectId, String clusterName, String[] argsArr, String mainClass, String jarFileUris) {
        // Configure the settings for the job controller client.
<span class="fc" id="L128">        String myEndpoint = String.format(&quot;%s-dataproc.googleapis.com:443&quot;, region);</span>
<span class="fc" id="L129">        JobControllerSettings jobControllerSettings =</span>
                null;
        try {
<span class="fc" id="L132">            jobControllerSettings = JobControllerSettings.newBuilder().setEndpoint(myEndpoint).build();</span>
<span class="nc" id="L133">        } catch (IOException e) {</span>
<span class="nc" id="L134">            return null;</span>
<span class="fc" id="L135">        }</span>

<span class="fc" id="L137">        List&lt;String&gt; resultList = null;</span>

        // Create a job controller client with the configured settings. Using a try-with-resources
        // closes the client,
        // but this can also be done manually with the .close() method.
<span class="pc" id="L142">        try (JobControllerClient jobControllerClient =</span>
<span class="nc" id="L143">                     JobControllerClient.create(jobControllerSettings)) {</span>

            // Configure cluster placement for the job.
<span class="nc" id="L146">            JobPlacement jobPlacement = JobPlacement.newBuilder().setClusterName(clusterName).build();</span>

<span class="nc" id="L148">            List&lt;String&gt; args = Arrays.asList(argsArr);</span>
            // Configure Spark job settings.
            SparkJob sparkJob =
<span class="nc" id="L151">                    SparkJob.newBuilder()</span>
<span class="nc" id="L152">                            .setMainClass(mainClass)</span>
<span class="nc" id="L153">                            .addJarFileUris(jarFileUris)</span>
<span class="nc" id="L154">                            .addAllArgs(args)</span>
<span class="nc" id="L155">                            .build();</span>

<span class="nc" id="L157">            Job job = Job.newBuilder().setPlacement(jobPlacement).setSparkJob(sparkJob).build();</span>

            // Submit an asynchronous request to execute the job.
<span class="nc" id="L160">            OperationFuture&lt;Job, JobMetadata&gt; submitJobAsOperationAsyncRequest =</span>
<span class="nc" id="L161">                    jobControllerClient.submitJobAsOperationAsync(projectId, region, job);</span>

<span class="nc" id="L163">            Job response = submitJobAsOperationAsyncRequest.get();</span>

            // Print output from Google Cloud Storage.
<span class="nc" id="L166">            Matcher matches =</span>
<span class="nc" id="L167">                    Pattern.compile(&quot;gs://(.*?)/(.*)&quot;).matcher(response.getDriverOutputResourceUri());</span>
<span class="nc" id="L168">            matches.matches();</span>

<span class="nc" id="L170">            Storage storage = StorageOptions.getDefaultInstance().getService();</span>
<span class="nc" id="L171">            Blob blob = storage.get(matches.group(1), String.format(&quot;%s.000000000&quot;, matches.group(2)));</span>

<span class="nc" id="L173">            String dataprocLog = new String(blob.getContent());</span>
<span class="nc" id="L174">            log.info(&quot;Dataproc job finished successfully: {}&quot;, dataprocLog);</span>

<span class="nc" id="L176">            String[] dataprocLogLines = dataprocLog.split(&quot;\\r?\\n&quot;);</span>
<span class="nc" id="L177">            String resultStr = dataprocLogLines[dataprocLogLines.length-1];</span>
<span class="nc" id="L178">            String[] resultArr = resultStr.split(&quot;,&quot;);</span>
<span class="nc" id="L179">            resultList = Arrays.asList(resultArr);</span>
<span class="nc" id="L180">            return resultList;</span>
<span class="fc" id="L181">        } catch (Exception ignored) {</span>
<span class="fc" id="L182">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>