<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RecommendationService</a> &gt; <a href="index.source.html" class="el_package">com.whattoeattoday.recommendationservice.database.service.impl</a> &gt; <span class="el_source">DatabaseServiceImpl.java</span></div><h1>DatabaseServiceImpl.java</h1><pre class="source lang-java linenums">package com.whattoeattoday.recommendationservice.database.service.impl;

import com.whattoeattoday.recommendationservice.common.BaseResponse;
import com.whattoeattoday.recommendationservice.common.Status;
import com.whattoeattoday.recommendationservice.database.request.table.BuildTableRequest;
import com.whattoeattoday.recommendationservice.database.request.table.DeleteTableRequest;
import com.whattoeattoday.recommendationservice.database.request.table.QueryTableRequest;
import com.whattoeattoday.recommendationservice.database.request.table.UpdateTableRequest;
import com.whattoeattoday.recommendationservice.database.response.QueryTableNamesResponse;
import com.whattoeattoday.recommendationservice.database.response.QueryTableResponse;
import com.whattoeattoday.recommendationservice.database.service.DatabaseService;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.math.BigInteger;
import java.util.*;

/**
 * @author Jiarong Shi js6132@columbia.edu
 * @date 10/15/23
 */
<span class="pc bpc" id="L24" title="1 of 2 branches missed.">@Service</span>
<span class="fc" id="L25">public class DatabaseServiceImpl implements DatabaseService {</span>

    @Resource
    private JdbcTemplate jdbcTemplate;
    @Override
    public BaseResponse buildTable(BuildTableRequest request) {
<span class="fc" id="L31">        String tableName = request.getTableName();</span>
<span class="fc" id="L32">        List&lt;String&gt; fieldNameList = request.getFieldNameList();</span>
<span class="fc" id="L33">        List&lt;String&gt; fieldTypeList = request.getFieldTypeList();</span>
<span class="fc" id="L34">        StringBuilder sqlBuilder = new StringBuilder(String.format(&quot;CREATE TABLE IF NOT EXISTS `%s`( &quot;, tableName));</span>
<span class="fc bfc" id="L35" title="All 2 branches covered.">        for (int i = 0; i &lt; fieldNameList.size(); i++) {</span>
<span class="fc" id="L36">            String subSql = String.format(&quot;`%s` %s, \n&quot;, fieldNameList.get(i), fieldTypeList.get(i));</span>
<span class="fc" id="L37">            sqlBuilder.append(subSql);</span>
        }
<span class="fc" id="L39">        sqlBuilder.append(String.format(&quot; PRIMARY KEY (`%s`))\n ENGINE=InnoDB DEFAULT CHARSET=utf8;\n&quot;, request.getPrimaryKey()));</span>
        // Use try-catch to avoid failure to build table
        try {
<span class="fc" id="L42">            jdbcTemplate.execute(sqlBuilder.toString());</span>
<span class="nc" id="L43">        } catch (DataAccessException e) {</span>
<span class="nc" id="L44">            return BaseResponse.with(Status.DATABASE_ERROR);</span>
<span class="fc" id="L45">        }</span>

<span class="fc" id="L47">        UpdateTableRequest updateTableRequest = new UpdateTableRequest();</span>
<span class="fc" id="L48">        updateTableRequest.setTableName(tableName);</span>
<span class="fc" id="L49">        BaseResponse autoIncrResponse = null, uniqueKeyResponse = null;</span>
        // handle auto_increment
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (request.getAutoIncrementField() != null) {</span>
<span class="fc" id="L52">            updateTableRequest.setColumnName(request.getAutoIncrementField());</span>
<span class="fc" id="L53">            autoIncrResponse = setAutoIncrement(updateTableRequest);</span>
        }
        // handle unique_key
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (request.getUniqueKey() != null) {</span>
<span class="fc" id="L57">            updateTableRequest.setColumnName(request.getUniqueKey());</span>
<span class="fc" id="L58">            uniqueKeyResponse = setUniqueKey(updateTableRequest);</span>
        }
        // update table_record
<span class="fc" id="L61">        String columnNames = String.join(&quot;,&quot;, fieldNameList);</span>
<span class="fc" id="L62">        String columnTypes = String.join(&quot;,&quot;, fieldTypeList);</span>
<span class="fc" id="L63">        StringBuilder insertSql = new StringBuilder(String.format(&quot;INSERT IGNORE INTO `table_record` (name, column_names, column_types) VALUES ('%s', '%s', '%s')&quot;,</span>
                tableName, columnNames, columnTypes));
        try {
<span class="fc" id="L66">            jdbcTemplate.execute(insertSql.toString());</span>
<span class="nc" id="L67">        } catch (DataAccessException e) {</span>
<span class="nc" id="L68">            return BaseResponse.with(Status.PARAM_ERROR);</span>
<span class="fc" id="L69">        }</span>
<span class="pc bpc" id="L70" title="1 of 4 branches missed.">        boolean isAutoIncrementSuccess = request.getAutoIncrementField() != null &amp;&amp; !autoIncrResponse.isSuccess();</span>
<span class="pc bpc" id="L71" title="1 of 4 branches missed.">        boolean isSetUniqueKeySuccess = request.getUniqueKey() != null &amp;&amp; !uniqueKeyResponse.isSuccess();</span>
<span class="pc bpc" id="L72" title="2 of 4 branches missed.">        if (isAutoIncrementSuccess || isSetUniqueKeySuccess) {</span>
<span class="nc" id="L73">            return BaseResponse.with(Status.PARAM_ERROR);</span>
        }
<span class="fc" id="L75">        return BaseResponse.with(Status.SUCCESS);</span>
    }

    @Override
    public BaseResponse deleteTable(DeleteTableRequest request) {
<span class="fc" id="L80">        String tableName = request.getTableName();</span>
<span class="fc" id="L81">        StringBuilder sqlBuilder = new StringBuilder(String.format(&quot;DROP TABLE IF EXISTS `%s`&quot;, tableName));</span>
        try {
<span class="fc" id="L83">            jdbcTemplate.execute(sqlBuilder.toString());</span>
<span class="nc" id="L84">        } catch (DataAccessException e) {</span>
<span class="nc" id="L85">            return BaseResponse.with(Status.DATABASE_ERROR);</span>
<span class="fc" id="L86">        }</span>

        // update table_record
<span class="fc" id="L89">        StringBuilder deleteSql = new StringBuilder(String.format(&quot;DELETE FROM `table_record` WHERE name = '%s'&quot;, tableName));</span>
        try {
<span class="fc" id="L91">            jdbcTemplate.execute(deleteSql.toString());</span>
<span class="nc" id="L92">        } catch (DataAccessException e) {</span>
<span class="nc" id="L93">            return BaseResponse.with(Status.DATABASE_ERROR);</span>
<span class="fc" id="L94">        }</span>
<span class="fc" id="L95">        return BaseResponse.with(Status.SUCCESS);</span>
    }

    @Override
    public QueryTableResponse queryTable(QueryTableRequest request) {
<span class="fc" id="L100">        String tableName = request.getTableName();</span>
<span class="fc" id="L101">        StringBuilder sqlBuilder = new StringBuilder(String.format(&quot;SELECT id, name, row_num, column_names, column_types FROM `table_record` WHERE name = '%s'&quot;, tableName));</span>
        Map&lt;String, Object&gt; table;
        try {
<span class="fc" id="L104">            table = jdbcTemplate.queryForMap(sqlBuilder.toString());</span>
<span class="nc" id="L105">        } catch (DataAccessException e) {</span>
<span class="nc" id="L106">            return null;</span>
<span class="fc" id="L107">        }</span>

<span class="fc" id="L109">        QueryTableResponse queryTableResponse = new QueryTableResponse();</span>
<span class="fc" id="L110">        String[] columnNames = null;</span>
<span class="fc" id="L111">        String[] columnTypes = null;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        for (String key : table.keySet()) {</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (&quot;id&quot;.equals(key)) {</span>
<span class="fc" id="L114">                queryTableResponse.setId((BigInteger) table.get(key));</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            } else if (&quot;row_num&quot;.equals(key)) {</span>
<span class="fc" id="L116">                queryTableResponse.setRowNum((Long) table.get(key));</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            } else if (&quot;column_names&quot;.equals(key)) {</span>
<span class="fc" id="L118">                columnNames = ((String) table.get(key)).split(&quot;,&quot;);</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">            } else if (&quot;column_types&quot;.equals(key)) {</span>
<span class="fc" id="L120">                columnTypes = ((String) table.get(key)).split(&quot;,&quot;);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            } else if (&quot;name&quot;.equals(key)) {</span>
<span class="fc" id="L122">                queryTableResponse.setTableName((String) table.get(key));</span>
            }
<span class="fc" id="L124">        }</span>
<span class="fc" id="L125">        Map&lt;String, String&gt; nameTypeMap = new HashMap&lt;&gt;(10);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">        for (int i = 0; i &lt; Objects.requireNonNull(columnNames).length; i++) {</span>
<span class="pc bpc" id="L127" title="2 of 4 branches missed.">            assert columnTypes != null;</span>
<span class="fc" id="L128">            nameTypeMap.put(columnNames[i], columnTypes[i]);</span>
        }
<span class="fc" id="L130">        queryTableResponse.setFiledNameTypeMap(nameTypeMap);</span>
<span class="fc" id="L131">        return queryTableResponse;</span>
    }

    @Override
    public QueryTableNamesResponse queryTableNames() {
<span class="fc" id="L136">        String sql = &quot;SELECT name FROM `table_record`&quot;;</span>
<span class="fc" id="L137">        List&lt;Map&lt;String, Object&gt;&gt; result = null;</span>

        try {
<span class="fc" id="L140">            result = jdbcTemplate.queryForList(sql);</span>
<span class="nc" id="L141">        } catch (DataAccessException e) {</span>
<span class="nc" id="L142">            return null;</span>
<span class="fc" id="L143">        }</span>

<span class="fc" id="L145">        Set&lt;String&gt; names = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">        for (Map&lt;String, Object&gt; map : result) {</span>
<span class="fc" id="L147">            names.add((String) map.get(&quot;name&quot;));</span>
<span class="fc" id="L148">        }</span>
<span class="fc" id="L149">        QueryTableNamesResponse response = new QueryTableNamesResponse();</span>
<span class="fc" id="L150">        response.setTableNames(names);</span>
<span class="fc" id="L151">        return response;</span>
    }

    @Override
    public BaseResponse setAutoIncrement(UpdateTableRequest request) {
<span class="fc" id="L156">        String tableName = request.getTableName();</span>
<span class="fc" id="L157">        String columnName = request.getColumnName();</span>
<span class="fc" id="L158">        String sql = &quot;ALTER TABLE &quot; + tableName + &quot; MODIFY COLUMN &quot; + columnName + &quot; INT AUTO_INCREMENT;&quot;;</span>
        try {
<span class="fc" id="L160">            jdbcTemplate.execute(sql);</span>
<span class="nc" id="L161">        } catch (DataAccessException e) {</span>
<span class="nc" id="L162">            return BaseResponse.with(Status.PARAM_ERROR);</span>
<span class="fc" id="L163">        }</span>
<span class="fc" id="L164">        return BaseResponse.with(Status.SUCCESS);</span>
    }

    @Override
    public BaseResponse setUniqueKey(UpdateTableRequest request) {
<span class="fc" id="L169">        String tableName = request.getTableName();</span>
<span class="fc" id="L170">        String columnName = request.getColumnName();</span>
<span class="fc" id="L171">        String sql = &quot;ALTER TABLE &quot; + tableName + &quot; ADD CONSTRAINT unique_&quot; + columnName + &quot; UNIQUE (&quot; + columnName + &quot;)&quot;;</span>
        try {
<span class="fc" id="L173">            jdbcTemplate.execute(sql);</span>
<span class="fc" id="L174">        } catch (DataAccessException e) {</span>
<span class="fc" id="L175">            return BaseResponse.with(Status.PARAM_ERROR);</span>
<span class="fc" id="L176">        }</span>
<span class="fc" id="L177">        return BaseResponse.with(Status.SUCCESS);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>